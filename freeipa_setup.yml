- name: Instalación y configuración de BIND DNS en AlmaLinux
  hosts: freeipa_servers
  become: true
  vars:
    domain_name: "cefaslocalserver.com"
    dns_forwarders: "8.8.8.8"
    dns_records:
      - { name: "master1", ip: "10.17.4.21" }
      - { name: "master2", ip: "10.17.4.22" }
      - { name: "master3", ip: "10.17.4.23" }
      - { name: "worker1", ip: "10.17.4.24" }
      - { name: "worker2", ip: "10.17.4.25" }
      - { name: "worker3", ip: "10.17.4.26" }
      - { name: "storage1", ip: "10.17.4.27" }
      - { name: "freeipa1", ip: "10.17.3.11" }
      - { name: "loadbalancer1", ip: "10.17.3.12" }
      - { name: "loadbalancer2", ip: "10.17.3.13" }
      - { name: "postgresql1", ip: "10.17.3.14" }
      - { name: "bastion1", ip: "192.168.0.20" }

  tasks:
    - name: Instalar BIND y herramientas de DNS
      ansible.builtin.dnf:
        name:
          - bind
          - bind-utils
        state: present
        update_cache: true
      tags: install_bind

    - name: Configurar archivo named.conf
      ansible.builtin.template:
        src: named.conf.j2
        dest: /etc/named.conf
        owner: root
        group: named
        mode: "0644"
      notify: Restart named
      tags: configure_bind

    - name: Configurar zona DNS
      ansible.builtin.template:
        src: db.zone.j2
        dest: "/var/named/{{ domain_name }}.zone"
        owner: named
        group: named
        mode: "0644"
      notify: Restart named
      tags: configure_zone

    - name: Habilitar y arrancar el servicio named
      ansible.builtin.systemd:
        name: named
        enabled: true
        state: started
      tags: enable_named

    - name: Abrir puertos en el firewall para DNS
      ansible.builtin.firewalld:
        port: "{{ item }}"
        permanent: true
        state: enabled
      loop:
        - 53/tcp
        - 53/udp
      notify: Reload firewalld
      tags: firewall

  handlers:
    - name: Restart named
      ansible.builtin.systemd:
        name: named
        state: restarted

    - name: Reload firewalld
      ansible.builtin.systemd:
        name: firewalld
        state: reloaded